---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# demandacarros

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

A ideia aqui é desenhar o processo de estimar a demanda por carros novos no 
Brasil.
A ideia é rodar um BLP bem próximo do artigo original.
A equação principal deve ser algo nesse sentido:

q_{ji} = f(p_j, X_j, v_i)

A ideia é que a quantidade consumida do carro de modelo _j_ seja função de:

1. p_j: Preço do modelo _j_;
1. X_j: Características observáveis do modelo _j_;
1. v_i: Características observáveis do consumidor _i_.


> Rever essas notações.

Em função disso, vamos precisar 4 dados diferentes e de fontes diversas.

| Informação | Fonte |
| ---------- | ----- |
| Quantidade | Fenabrave |
| Preço | Fipe |
| Caracteísticas dos modelos | icarros + fichatecnica.com.br | 
| Caracteísticas dos consumidors | PNADc |

![](plano.png)

```{r}
library(carrosbr)
library(tidyverse)
# p_j
precos <- precos_fipe
head(precos)

# q_j
quantidades <- emplacamento_anual
head(quantidades)
```

Então podemos juntar os dados

```{r}
dados <- quantidades %>%
  dplyr::mutate(
    modelo = tolower(modelo) %>%
      stringr::str_replace(" ", "-"),
    montadora = tolower(montadora),
    montadora = dplyr::case_when(
      montadora == "gm" ~ "chevrolet",
      montadora == "vw" ~ "volkswagen",
      montadora == "vw/fox" ~ "volkswagen",
      montadora == "vw/man" ~ "volkswagen",
      montadora == "vw-trucks-e-bus" ~ "volkswagen",
      montadora == "m.benz" ~ "mercedes-benz",
      montadora == "caoa chery" ~ "caoa-chery",
      TRUE ~ montadora
    ),
    modelo = dplyr::case_when(
      modelo == "fox/cross-fox" ~ "fox",
      modelo == "etios-hb" ~ "etios",
      modelo == "yaris-hb" ~ "yaris",
      modelo == "cruze-sedan" ~ "cruze",
      modelo == "cruze-hb" ~ "cruze-sport6",
      modelo == "hilux-sw4" ~ "sw4",
      modelo == "space-fox" ~ "spacefox",
      modelo == "crv" ~ "cr-v",
      modelo == "206ws" ~ "206",
      modelo == "city-hatch" ~ "city-hatchback",
      modelo == "320i" ~ "serie-3",
      montadora == "kia" & stringr::str_detect(modelo, "k\\d+") ~ "bongo",
      stringr::str_detect(modelo, "sprinter-") ~ "sprinter",
      montadora == "ford" & stringr::str_detect(modelo, "f(?=\\d+)") ~
        stringr::str_replace(modelo, "f", "f-"),
      montadora == "iveco" & stringr::str_detect(modelo, "daily-") ~ "daily",
      TRUE ~ modelo
    )) %>% 
  left_join(precos, by = join_by(montadora, modelo, ano))

head(dados)
```

E olhar para o seu formato

```{r}
ggplot(dados %>% filter(ano > 2020), aes(quantidade, preco)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_log10() + 
  scale_y_log10() +   
  facet_wrap(~ano) +
  theme_bw()
```

Olhar para marcas selecionadas

```{r}
destaques <- c("byd", "fiat", "renault", "volkswagen", 
               "toyota", "chevrolet")
dados %>% 
  filter(ano == 2024, montadora %in% destaques) %>% 
  ggplot(aes(quantidade, preco, col = montadora)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  facet_wrap(~montadora) +
  theme_bw()
```

